name: Deploy Docker image

on:
  push:
    branches:
      - main  # ajuste ta branche principale ici

jobs:
  test:
    runs-on: ubuntu-latest

    # On ne lance le workflow que si le message du commit contient #deploy
    if: contains(github.event.head_commit.message, '#deploy')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run tests
        run: |
          npm test

      - name: Tests passed
        run: echo "‚úì Tous les tests sont pass√©s avec succ√®s !"

      - name: Notify Slack - Tests Success
        if: success()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "‚úÖ Tests r√©ussis pour ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚úÖ Tests r√©ussis*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.event.head_commit.message }}>\n*Author:* ${{ github.event.head_commit.author.name }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Tests Failed
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "‚ùå Tests √©chou√©s pour ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚ùå Tests √©chou√©s*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.event.head_commit.message }}>\n*Author:* ${{ github.event.head_commit.author.name }}\n‚ö†Ô∏è Le d√©ploiement a √©t√© annul√©"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test  # Ce job ne s'ex√©cute que si le job 'test' r√©ussit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Scaleway Container Registry
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_REGISTRY_ENDPOINT: ${{ secrets.SCW_REGISTRY_ENDPOINT }}
        run: |
          echo "${SCW_SECRET_KEY}" | docker login "${SCW_REGISTRY_ENDPOINT}" \
            --username "${SCW_ACCESS_KEY}" --password-stdin

      - name: Build Docker image
        run: |
          IMAGE_NAME="${{ secrets.SCW_REGISTRY_ENDPOINT }}/clouet-renaudin-javor"
          IMAGE_TAG="${GITHUB_SHA::7}"  # tag court bas√© sur le SHA du commit
          docker build -t "$IMAGE_NAME:$IMAGE_TAG" -t "$IMAGE_NAME:latest" .

      - name: Push Docker image
        run: |
          IMAGE_NAME="${{ secrets.SCW_REGISTRY_ENDPOINT }}/clouet-renaudin-javor"
          IMAGE_TAG="${GITHUB_SHA::7}"
          docker push "$IMAGE_NAME:$IMAGE_TAG"
          docker push "$IMAGE_NAME:latest"

      - name: Notify Slack - Deploy Success
        if: success()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "üöÄ D√©ploiement r√©ussi pour ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üöÄ D√©ploiement r√©ussi*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.event.head_commit.message }}>\n*Author:* ${{ github.event.head_commit.author.name }}\n*Image Tag:* ${GITHUB_SHA::7}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Deploy Failed
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "‚ùå D√©ploiement √©chou√© pour ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚ùå D√©ploiement √©chou√©*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.event.head_commit.message }}>\n*Author:* ${{ github.event.head_commit.author.name }}\n‚ö†Ô∏è Erreur lors du build ou push Docker"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}