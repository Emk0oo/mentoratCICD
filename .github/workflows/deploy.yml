name: Deploy Docker image

on:
  push:
    branches:
      - main  # ajuste ta branche principale ici

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # On ne lance le déploiement que si le message du commit contient #deploy
    if: contains(github.event.head_commit.message, '#deploy')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Scaleway Container Registry
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_REGISTRY_ENDPOINT: ${{ secrets.SCW_REGISTRY_ENDPOINT }}
        run: |
          echo "${SCW_SECRET_KEY}" | docker login "${SCW_REGISTRY_ENDPOINT}" \
            --username "${SCW_ACCESS_KEY}" --password-stdin

      - name: Build Docker image
        run: |
          IMAGE_NAME="${{ secrets.SCW_REGISTRY_ENDPOINT }}/clouet-renaudin-javor"
          IMAGE_TAG="${GITHUB_SHA::7}"  # tag court basé sur le SHA du commit
          docker build -t "$IMAGE_NAME:$IMAGE_TAG" -t "$IMAGE_NAME:latest" .

      - name: Push Docker image
        run: |
          IMAGE_NAME="${{ secrets.SCW_REGISTRY_ENDPOINT }}/clouet-renaudin-javor"
          IMAGE_TAG="${GITHUB_SHA::7}"
          docker push "$IMAGE_NAME:$IMAGE_TAG"
          docker push "$IMAGE_NAME:latest"